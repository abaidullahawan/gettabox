<table class="table table-hover text-vertical-middle mb-0">
  <thead class="bort-none borpt-0">
    <tr>
      <th>
        <input type="checkbox" id="customSwitchAll" name="" value="" class='select-all-checkbox'>
      </th>
      <th scope="col">Channel</th>
      <th scope="col">Order Information</th>
      <th scope="col">Listings</th>
      <th scope="col">Information</th>
      <th scope="col">Courier Service</th>
      <th scope="col">Tracking</th>
      <th scope="col">Date</th>
      <th scope="col">Total</th>
      <th scope="col">Status</th>
      <!--th scope="col"></th-->
    </tr>
  </thead>
  <% channel_orders.each.with_index(1) do |order, index| %>
    <tbody>
      <tr>
        <td>
          <div id="<%=order.id%>" class= 'orders-switch' name="orders-switch">
            <input id="object_ids[]" class="ml-2 form_field_questions" type="checkbox" data-courier="<%= order.assign_rule&.mail_service_rule&.courier&.name %>" data-export="<%= order.assign_rule&.mail_service_rule&.export_mapping_id %>" data-item="<%= order.channel_order_items.count %>" value="<%=order.id%>" name="object_ids[]">
            <%# f.check_box 'object_ids[]', {'data-item': order.channel_order_items.count}, order.id %>
          </div>
        </td>
        <td style = "width: 180px">
          <%= render  'image_partial', order: order %>
        </td>
        <td style="width: 170px;">
          <%= order.order_id %>
          <br><%= order.buyer_username %>
          <br><strong><b><%= order.buyer_name %></b></strong>
          <br><span class="sku-width"><%= order.system_user&.addresses&.find_by(address_title: 'delivery')&.address%></span>
        </td>
        <td style="width: 320px">
          <% order.channel_order_items&.each do |product|%>
            <%= link_to product_mappings_path(q:{item_sku_or_listing_id_cont: product.sku}) do %>
              <div class="card-style px-3 mt-1 relative">
                <div>
                  <span class="order-listing order-quantity"><%= product.ordered %></span>
                  <div class="d-flex">
                    <div>
                      <% if product.channel_product&.item_image.present?%>
                          <%= image_tag(product.channel_product.item_image, width: '55px', height: '80px', class: 'mr-3')%>
                      <% else %>
                        <%= image_tag('user/1.jpg', width: "50px", height: "50px", class: 'mr-3 img-thumbnail img-height', alt: 'User Image') %>
                      <% end %>
                    </div>
                    <div>
                      <% title = product&.channel_product.present? ? product&.channel_product&.item_name : product&.product&.title %>
                      <span class="truncate text-white" title="<%= title %>"><%= title %></span><br>
                      <b class = "text-white"><%= product.line_item_id if product.line_item_id.present? %></b><br>
                      <div class="sku-width text-white"><%= product&.sku if product&.sku.present? %></div>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
          <% end %>
        </td>
        <td style="width: 250px;">
          <% order.channel_order_items.each do |product|%>
            <% if product.channel_product&.product_mapping.present? || product.product.present?  %>
              <% if product.channel_product&.product_mapping&.product&.product_type_multiple? %>
                <% product.channel_product&.product_mapping&.product&.multipack_products&.each do |record| %>
                <% light_color = product.allocated ? 'bg-success-light' : 'bg-danger'%>
                <% dark_color = product.allocated ? 'bg-success-dark' : 'bg-danger-dark'%>
                <div class="card-style2 <%=light_color%>">
                  <%= link_to record.child.sku, product_path(record.child.id), target: 'blank' %>
                  <p style="color: white;">
                    <b>Location:</b> <span><%= record.child.location %></span>
                  </p>
                  <p style="color: white;">
                    <b>QTY:</b> <span><%= record.quantity * product.ordered.to_i * (record.child.pack_quantity.nil? ? 1 : record.child.pack_quantity).to_i %></span>
                  </p>
                  <div class="d-flex">
                    <div class="col-4 col-padding">
                      <p class="heading-table <%=dark_color%>">Avail</p>
                      <p class="table-value <%=dark_color%>"><%= record.child.available_stock.to_i %></p>
                    </div>
                    <div class="col-4 col-padding">
                      <p class="heading-table <%=dark_color%>">Alloc</p>
                      <p class="table-value <%=dark_color%>"><%= record.child.allocated.to_i  %></p>
                    </div>
                    <div class="col-4 col-padding">
                      <p class="heading-table <%=dark_color%>">Disp</p>
                      <p class="table-value <%=dark_color%>">0</p>
                    </div>
                  </div>
                </div>
                <% end %>
              <% else %>
                <% local_product = product.channel_product&.product_mapping&.product || product.product %>
                <% light_color = product.allocated ? 'bg-success-light' : 'bg-danger'%>
                <% dark_color = product.allocated ? 'bg-success-dark' : 'bg-danger-dark'%>
                <div class="card-style2 <%=light_color%>">
                  <%= link_to local_product&.sku, product_path(local_product&.id), target: 'blank', style: "color: white" %>
                  <p style="color: white;">
                    <b>Location:</b> <span><%= local_product&.location %></span>
                  </p>
                  <p style="color: white;">
                    <b>QTY:</b> <span><%= (local_product.pack_quantity.nil? ? 1 : local_product.pack_quantity ).to_i * product.ordered.to_i %></span>
                  </p>
                  <div class="d-flex">
                    <div class="col-4 col-padding">
                      <p class="heading-table <%=dark_color%>">Avail</p>
                      <p class="table-value <%=dark_color%>"><%= local_product&.available_stock.to_i %></p>
                    </div>
                    <div class="col-4 col-padding">
                      <p class="heading-table <%=dark_color%>">Alloc</p>
                      <p class="table-value <%=dark_color%>"><%= local_product&.allocated.to_i %></p>
                    </div>
                    <div class="col-4 col-padding">
                      <p class="heading-table <%=dark_color%>">Disp</p>
                    <p class="table-value <%=dark_color%>">0</p>
                  </div>
                  </div>
                </div>
              <% end %>
            <% end %>
          <% end %>
        </td>
        <td>
          <% if order.assign_rule.present? %>
            <span class="mt-2 mr-2 badge badge-warning mb-1"><%= order.assign_rule&.status %></span>
            <span class="update-rule-modal click_able_cursor" data-id= "<%= order.id %>"data-index= "<%=index%>">
              <div class = "text-success"><%= order.assign_rule&.mail_service_rule&.rule_name %></div>
              <div class = "text-info"><%= order.assign_rule&.mail_service_rule&.service&.name%></div>
            </span>
            <form> </form>
            <%= form_for order.assign_rule, url: assign_rule_path(order.assign_rule.id ), method: :put do |ar| %>
              <div class="modal fade" id="mail-service-roles-update-modal-<%=index%>" tabindex="-1" role="dialog" aria-labelledby="exampleModalScrollableTitle" aria-hidden="true">
                <div class="modal-dialog modal-dialog-scrollable" role="document">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Mail Service Rule</h5>
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>
                    <div class="modal-body">
                      <%= hidden_field_tag :update_channel_order_id, order.id %>
                      <%= render partial: 'update_assign_rule_form', locals: { f: ar }  %>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary mr-auto" data-dismiss="modal">Close</button>
                        <%= ar.submit "Assign" , class: 'btn btn-outline-primary create_service_rule_button' %>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
          <% else %>
            <div class="shipment_modal cursur-pointer" data-id="<%= order.id %>" id="shipment_modal_<%=index%>">
              <span class=" text-danger py-1">Please Select Service Rule</span>
              <% @length = 0%>
              <% @weight = 0%>
              <% @height = []%>
              <% @width = []%>
              <% order.channel_order_items.each do |product|%>
                <% if product.channel_product&.product_mapping.present? %>
                  <% if product.channel_product.product_mapping.product&.product_type_multiple? %>
                    <% product.channel_product.product_mapping.product&.multipack_products&.each do |record| %>
                      <% @length += record&.child&.length.to_f * record.quantity.to_f %>
                      <% @weight += record&.child&.weight.to_f * record.quantity.to_f%>
                      <% @height.push(record&.child&.height.to_f)%>
                      <% @width.push(record&.child&.width.to_f)%>
                    <% end %>
                  <% else %>
                    <% @length += product.channel_product.product_mapping&.product&.length.to_f %>
                    <% @weight += product.channel_product.product_mapping&.product&.weight.to_f %>
                    <% @height.push( product.channel_product.product_mapping&.product&.height.to_f)%>
                    <% @width.push( product.channel_product.product_mapping&.product&.width.to_f)%>
                  <% end %>
                <% end %>
              <% end %>
              <%= hidden_field_tag 'length',  @length, class: "length-value" %>
              <%= hidden_field_tag 'width',  @width.max, class: "width-value" %>
              <%= hidden_field_tag 'height',  @height.max, class: "height-value"%>
              <%= hidden_field_tag 'weight',  @weight, class: "weight-value"%>
            </div>
          <% end %>
        </td>
        <td>
          <% if order.assign_rule %>
            <%= order.assign_rule.mail_service_rule&.courier&.name %><br>
            <%= ExportMapping.find_by(id: order.assign_rule&.mail_service_rule&.export_mapping_id)&.sub_type %>
          <% end %>
          <% if order.trackings.present? %>
            <% order.trackings.each do |tracking| %>
              <%= tracking.tracking_no %>
            <% end %>
          <% end %>
        </td>
        <td style="width: 100px;"><%= order.created_at.strftime("%m/%d/%Y %H:%M") %></td>
        <td><%= order.total_amount%></td>
        <td>
          <span class="badge badge_warning py-1"><%= order.order_status%></span><br>
            <div class="dropdown dropleft">
              <button class="btn btn-primary" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" title="Actions">
                <i data-feather='bell' class='icon wh-15 mt-minus-3'></i>
              </button>
              <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                <a class="dropdown-item" href="<%= order_dispatch_path(order)%>" >Show</a>
                <% if (order.channel_order_items.map{|i| i.allocated} & [true]).any? %>
                  <%= link_to 'Unallocate', allocations_order_dispatches_path(allocate: false, listing_id: order.id, order_filter: params[:order_filter]), class: 'dropdown-item' %>
                <% else %>
                  <%= link_to 'Allocate', allocations_order_dispatches_path(allocate: true, listing_id: order.id, order_filter: params[:order_filter]), class: 'dropdown-item' %>
                <% end %>
                <%= link_to 'Logs', version_order_dispatches_path(id: order.id), class: 'dropdown-item' %>
              </div>
            </div>
        </td>
      </tr>
    </tbody>
  <% end %>
</table>
